- **一、什么是以太坊**

    以太坊是一个由世界各地的计算机组成的网络，遵循一套称为以太坊协议的规则。以太坊网络提供了一个基础，任何人都可以在上面构建和使用社区、应用程序、组织和数字资产。

    一个开放源代码、去中心化的区块链平台，使开发者能够创建和部署智能合约及去中心化应用（DApps）。

    以太坊还构建了一个包含去中心化金融（DeFi）、非同质化代币（NFT）和去中心化自治组织（DAO）等在内的广泛应用和服务的生态系统。以太坊网络通过以太币（ETH）支付交易费用（称为 Gas），激励网络参与者共同维护和运行这个平台。

    实际上，以太坊被视作一个“状态机”，通过智能合约的代码更新其状态。执行这些智能合约代码，需要消耗以太币（ether），而这个过程是通过一种名为“权益证明”（Proof of Stake, PoS）的共识机制进行验证并在整个网络中广播同步的。

- **二、以太坊历史**

    - 奥林匹克（Olympic）

        - 以太坊区块链在2015年5月开始向用户（主要是开发者）开放使用。版本称为“奥林匹克”，这是一个测试版本。主要供开发人员提前探索以太坊区块链开放以后的运作方式，比如测试交易活动、虚拟机使用、挖矿方式和惩罚机制，同时尝试使网络过载，并对网络状态进行极限测试，以了解协议如何处理大量流量。

    - 边疆（Frontier）

        - 经过几个月对奥林匹克的压力测试，以太坊在2015年7月30日发布官方公共主网，第一个以太坊创世区块产生。边疆依旧是一个很初级的版本，交易都是通过命令行来完成。

            不过，边疆版本已经具备以太坊的一系列关键特征：

            （1）区块奖励：当矿工成功挖出一个新区块并确认后，矿工仅得到5个以太币的奖励。

            （2）Gas机制：通过gas来限制交易和智能合约的工作量。

            （3）引入了合约概念。

    - 家园（Homestead）

        - 家园是以太坊网络的首次硬分叉升级计划，在2016年3月14日发生在第1,150,000个区块上。家园版本主要为以太坊带来了主要更新有:

            （1）完善了以太坊编程语言Solidity；

            （2）上线Mist钱包，使用户能够通过UI界面持有或交易ETH，编写或部署智能合约。

        - 家园升级是第一个通过以太坊改进提案（EIP）实施的分叉升级

            > EIP（Ethereum Improvement Proposal）即以太坊改进提案，是以太坊去中心化治理的一部分，所有人都可以提出治理的改进方案，当社区讨论通过后，就会囊括在网络升级版本中。

    - DAO分叉

        - 这是一个计划外的分叉，并非为了功能升级，而是以太坊社区为了对黑客攻击防止损失，而采取的硬分叉回滚了黑客的交易。事情是这样的： 2016年，去中心化自治组织 “The DAO” 通过发售DAO 代币募集了1.5亿美元的资金，作为 DAO 代币持有人可以投票及审查投资项目，并获得一定比例的项目收益，所有的资金均由智能合约管理。然后在2016年6月，the DAO合约遭到黑客攻击，黑客可以利用漏洞源源不断的从合约中盗取以太币。

        - 最终在以太坊社区投票后实行了硬分叉（在1920000块高度时发生），将资金返还到原钱包并修复漏洞。不过这次硬分叉仍旧引来很大的争议，以太坊社区的一些成员认为这种硬分叉方式违背了“Code Is Law” 原则，他们选择继续在原链上进行挖矿和交易。未返还被盗资金的原链则演变成以太坊经典（ETC）。

    - 拜占庭（Byzantium）

        - 拜占庭（Byzantium）和君士坦丁堡（Constantinople） 是以太坊称为“大都会”（Metropolis）升级的两个阶段。拜占庭在2017年10 月第4,370,000个区块上激活，拜占庭分叉更新有：增加“REVERT”操作符、增加一些加密方法、调整难度计算、推迟难度炸弹、调整区块奖励（5个减为3个）。

            > “难度炸弹”（Difficulty Bomb）是这样一种机制：一旦被激活，将增加挖掘新区块所耗费的成本（即“难度”），直到难度系数变为不可能或者没有新区块等待挖掘。这在以太坊中称为进入冰河时代，“难度炸弹”机制在2015年9月就被引入以太坊网络。它的目的是促使以太坊最终从工作量证明（PoW）转向权益证明（PoS）。因为从理论上来说，未来在PoS机制下，矿工仍然可以选择在旧的PoW链上作业，而这种行为将导致社区分裂，从而形成两条独立的链。为了预防这种情况的发生，通过“难度炸弹”增加难度，将最终淘汰PoW挖矿，促使网络完全过渡到PoS机制。

    - 君士坦丁堡（Constantinople）

        - “大都会”升级的第二阶段被称作“君士坦丁堡”，原计划于2019年1月中旬在第7,080,000个区块上执行。不过由于潜在的安全问题，以太坊核心开发者和社区其他成员投票决定推迟升级，直到该安全漏洞得以修复。最终在在2019 年2月28日区块高度7,280,000上得到执行。

        - 其中主要的EIPs包括：EIP145——增加按位移动指令；EIP1052——允许智能合约只需通过检查另一个智能合约的哈希值来验证彼此；EIP1014——添加了新的创建合约的指令CREATE2；EIP1234——区块奖励从每块3 ETH减少到2 ETH，难度炸弹推迟12个月。

    - 伊斯坦布尔（Istanbul）

        - 伊斯坦布尔是在9069000在块高执行的，执行时间是在2019 年12月8日，伊斯坦布尔分叉有以下几个重要改进：

            1. 降低calldata（是一个存储数据的位置，将在第 6 章介绍）参数的 gas 消耗（EIP2028）；

            2. 降低 alt_bn128(椭圆曲线) 预编译函数的 gas 消耗（EIP1108）；

            3. 增加了 chainid 操作码，让智能合约可以识别自己在主链还是分叉链或二层网络扩容链上（EIP-1344）；

            4. 添加 BLAKE2 预编译函数，让以太坊可以和专注隐私功能的 Zcash 链交互，提高以太坊的隐私能力。

        - 其中 1 2 3 点对以太坊的二层网络扩容方案是重大利好，因为很多二层网络方案会把很多交易打包在一起传递给智能合约验证（通过alt_bn128函数验证）。

    - 信标链创世块

        - 2020 年 12 月 1 日，信标链正式启动，是以太坊迈向 POS 共识的重要一步。

        - 信标链启动后，以太坊有两条独立的链，但此时的信标链仅可以进行共识，无法进行任何交易。

    - 柏林（Berlin）

        - 柏林升级在12244000进行，优化了某些以太坊虚拟机操作的燃料成本，并增加了对多种交易类型的支持，柏林升级的修改有：

        - EIP-2565 – 减少 ModExp 燃料成本

        - EIP-2718 – 更轻松地支持多种交易类型

        - EIP-2929 – 状态访问操作码的燃料成本增加

        - EIP-2930 – 添加可选访问列表

    - 伦敦（London）

        - 伦敦升级在 12965000 进行（2021/08/05 日）。引入了 EIP-1559，对交易费进行了修改，同时还对交易费用的退款处理进行了修改，修改有：

        - EIP-1559 - 改善交易费市场

        - EIP-3198 - 从区块返回 BASEFEE

        - EIP-3529 - 减少以太坊虚拟机操作的Gas退款

        - EIP-3541 - 防止部署以“0xEF”开头的合约

        - EIP-3554 - 将冰河世纪推迟到 2021 年 12 月

    - TheMerge 合并

        - 2022年9月15日，信标链与以太坊 POW 链合并，这是一个重要的里程碑，合并之后不再使用 POW 共识，合并之后，两条链使用新名字：共识层与执行层。

        - 执行层负责交易执行（EVM），共识层负责共识出块。

    - 以 rollup 为中心的开发路线

        1. **共识机制与基础架构**
自 2022 年完成 “合并” 后，以太坊已全面转向 PoS 机制，验证者通过质押 ETH 参与区块验证，网络能耗降低 99.95%5。2023 年上海升级（Shapella）实现了质押 ETH 的灵活赎回，进一步吸引了超 100 万验证者参与，质押总量超过 2100 万 ETH，确保了网络的安全性和去中心化2122。当前 PoS 机制稳定运行，验证者集通过动态调整保持分散，例如 Pectra 升级（2025 年 4 月）将验证者最大余额（MaxEB）提升，为后续分片扩展释放资源。

        2. **分片扩容的分阶段推进**
分片是以太坊提升扩展性的核心策略，目前处于**Proto-Danksharding 阶段**（通过 EIP-4844 实现），引入新型 Blob 数据格式存储链下数据，显著降低 Layer 2 交易费用（如 Rollup 成本下降约 70%）36。2025 年 4 月的 Pectra 升级将 Blob 数量从 3 个增加到 6 个，使 Layer 2 容量翻倍，同时优化了数据可用性和交易吞吐量1016。下一阶段的**Fusaka 升级**（预计 2025 年下半年）将引入 PeerDAS（对等数据可用性抽样），通过 P2P 网络优化数据存储，为全面分片（Danksharding）奠定基础，并计划将 Gas 限制从 3750 万提升至 1.5 亿，进一步提升 Layer 1 执行能力。

        3. **Layer 2 生态的爆发式增长**
分片与 Rollup 的协同效应显著，Layer 2 交易量自 2023 年以来增长 91%，2025 年 6 月周活跃地址数达 1740 万，创历史新高78。Arbitrum、Optimism 等 Rollup 网络的 TPS 已超过 2000，且交易费用低于主网 90% 以上7。坎昆升级（Dencun）后，Blob 数据的引入进一步降低了 Layer 2 上链成本，推动了 DeFi、NFT、全链游戏等应用的繁荣，例如 DeFi 总锁仓价值（TVL）在 2025 年 6 月达到 866.3 亿美元

- **三、账户模型**

    ### 外部拥有账户（EOAs-Externally Owned Accounts）

    - 控制方式：任何拥有私钥的人控制。

    - 功能：用户可以通过创建和签署交易来发送消息，进行 ETH 转移或与智能合约互动。

    - 地址：20 字节，由其公钥派生而来。

    - 特点：EOAs 直接由用户控制，安全性依赖于私钥的保管。这类账户是以太坊网络中与人类用户直接相关的账户类型，允许用户参与以太坊网络的经济活动和应用生态系统。

    ### 合约账户（Contract Accounts）

    - 控制方式：智能合约代码控制。

    - 功能：当合约账户接收到消息时，其内部代码会自动执行，允许账户根据逻辑读写内部存储、发送其他消息或创建新合约。

    - 地址：20 字节，由合约创建时的交易数据派生而来。

    - 特点：合约账户的行为完全由其内部代码决定，实现了代码的自动执行和自治操作，但只能通过外部账户发起消息调用来执行代码。

    ### 账户字段

    - Nonce：用于记录外部账户发起的交易数量或合约账户创建的合约数量。

        - 外部账户的 nonce 从0开始计数，合约账户的 nonce 从1开始。

    - Balance：账户拥有的以太币数量，以Wei为单位（1 ETH = 1e+18 Wei）。

    - CodeHash：合约账户的 EVM 代码的哈希值。对于合约账户，CodeHash代表可执行的智能合约代码，该代码在账户接收到消息调用时执行。

        - 对于外部账户，此字段为空字符串的哈希。

    - StorageRoot：也称为存储哈希，是 Merkle Patricia Trie 根节点的256位哈希，编码了账户的存储内容。这个 Trie 树以键值对形式存储账户的数据，对于新账户，默认为空。

    **只有外部用户账户可以发起交易（主动行为），而合约账户只能被动地响应操作，并且所有的手续费（Gas）必须由外部账户支付**。

- **四、状态与数据存储**

    - 世界状态树

        世界状态树存储了以太坊网络中所有账户的信息，包括账户的余额、nonce、合约代码和合约存储等信息，它是以太坊网络状态的全面记录，任何账户状态的变化都会反映在这棵树的更新中。

    - 交易树

        交易树记录了某个区块中所有交易的信息。每笔交易都通过其哈希值在树中找到对应的位置，它保证了区块中交易数据的完整性和可验证性，使得任何人都能高效地验证交易数据的正确性。

    - 回执树

        回执树存储了每笔交易执行后的回执信息，包括交易的执行结果、消耗的Gas和日志事件等，它为交易执行的结果提供了透明度，允许任何人验证交易的执行情况和智能合约的事件日志。

- **五、交易**

    #### 1. 交易的字段

    - `from`- 发送者的地址，该地址将签署交易。 这将是一个外部帐户，因为合约帐户不能发送交易。

    - `recipient`- 接收地址（如果是外部帐户，交易将传输值。 如果是合约帐户，交易将执行合约代码）

    - `signature`- 发送者的标识符。 当发送者的私钥签署交易并确保发送者已授权此交易时，生成此签名。

    - `nonce` - 一个有序递增的计数器，表示来自帐户的交易数量

    - `value` - 发送者向接收者转移的以太币数量（面值为 WEI，1 个以太币 = 1e+18wei）

    - `input data` - 可包括任意数据的可选字段

    - `gasLimit` - 交易可以消耗的最大数量的燃料单位。 以太坊虚拟机指定每个计算步骤所需的燃料单位

    - `maxPriorityFeePerGas` - 作为小费提供给验证者的已消耗燃料的最高价格

    - `maxFeePerGas` - 愿意为交易支付的每单位燃料的最高费用（包括 baseFeePerGas 和 maxPriorityFeePerGas）

    #### 2. 交易的类型

    - **常规交易**：从一个账户到另一个账户。

    - **合约部署交易：**“to”字段为空，data字段包含智能合约的字节码。

    - **执行合约**：用于调用已部署的智能合约的函数。这种交易类型的`to`字段包含目标合约地址，`data`字段包含函数名称和参数。

    #### 3. 交易的生命周期

    1. 创建和签名：交易由用户创建并使用私钥签名，以证明交易的发起者拥有执行交易的权限。

    2. 广播：签名的交易被广播到以太坊网络。一旦交易进入网络，它会被传播到网络中的多个节点。这样，交易就开始在网络中传播，最终到达矿工节点，进入待处理的交易池。

    3. 打包和验证： 矿工会从交易池中选择要包含在下一个区块中的交易。通常，矿工会选择具有较高燃料费用（gas）的交易，因为他们可以通过处理这些交易来获取更高的奖励。矿工选择后，验证其有效性，然后将其打包进新的区块中。

    4. 执行：一旦交易被打包进区块并被网络确认，交易将被执行。这可能包括转移以太币、执行智能合约代码等操作。

    5. 最终确认：随着更多区块被挖掘并附加到区块链上，交易获得更多确认，其被逆转的可能性越来越小，最终成为不可更改的一部分。

- **六、Ether**

    以太坊(Ethereum)是区块链，以太币(ETH)是以太坊的原生资产，以 Wei 作为最小单位，其中1 Ether 等于10^18 Wei。它在以太坊生态系统中扮演着至关重要的角色，用于支付交易费用、执行智能合约，以及在过去的工作量证明（PoW）机制下作为矿工的激励机制。随着以太坊转向权益证明（PoS）机制，Ether 同样用于激励验证者（Validators）。

    ```Plain Text
    1 ether = 10^3 finney（即1000 finney）
    1 ether = 10^6 szabo
    1 ether = 10^18 wei
    1 Gwei = 10^9 wei
    1 Mwei = 10^6 wei
    ```

    #### 产生方式

    1. **初始分配（众筹）**：在以太坊网络启动之初，通过2014年的众筹（ICO）进行了初始的 Ether 分配。投资者用比特币（BTC）购买了 Ether，这些 Ether 在以太坊网络启动时被创建并分配给了参与众筹的投资者。

    2. **区块奖励（在PoW机制下）**：在以太坊采用工作量证明机制时，矿工通过解决复杂数学难题来验证交易并创建新区块，作为回报获得新产生的 Ether。这个过程不仅确保了网络的去中心化和安全性，也是新 Ether 进入流通的主要途径。

    3. **质押奖励（在PoS机制下）**：随着以太坊升级到2.0版本并转向权益证明机制，Ether 的产生方式也随之改变。在 PoS 机制中，持币者通过锁定一定数量的 Ether 作为质押，获得成为网络验证者的资格。验证者负责验证交易和提议新区块，作为回报获得新产生的 Ether。这种方式减少了对大量计算资源的需求，降低了网络的能源消耗。

    4. **交易费用和燃烧**：除了通过区块奖励产生外，Ether 还通过交易费用在用户之间流通。在 EIP-1559 提案实施后，网络开始燃烧部分交易费用中的基础费用，减少了 Ether 的总供应量，这一机制有助于控制通胀并可能对 Ether 的价值产生积极影响。

    #### Ether的经济和技术意义

    - 经济意义：作为以太坊网络的原生货币，Ether 是去中心化金融（DeFi）生态系统中的主要流通货币，支持了广泛的金融产品和服务。

    - 技术意义：Ether 支付的交易费用激励了网络参与者（无论是矿工还是验证者）维护网络的安全和稳定，同时促进了智能合约和 DApps 的运行。

- **七、智能合约与 EVM**

    - 智能合约是以太坊上运行的程序。

    - 就像其他计算机程序一样，它由代码和数据组成。

    - 智能合约中的数据通常被称为“状态”，因为整个区块链可以看作是所有数据状态的一个确定的记录。

    - 以太坊的智能合约是“图灵完备”的，这意味着理论上我们可以使用它来编写执行任何任务的程序。

    - 在以太坊上，智能合约是以 Ethereum Virtual Machine (EVM) 字节码的形式存储的。

    - EVM 是以太坊的运行环境，是一个基于堆栈的虚拟机，它是分布式的，运行在以太坊网络中的每个节点上，确保了网络中任何节点都能独立验证智能合约的执行结果。

    - 智能合约在部署到以太坊时，都会被编译成 EVM 可执行的字节码。当智能合约被触发时（例如，通过用户发送的交易或其他合约的调用），EVM 会加载合约的字节码并解释执行这些字节码，执行过程中，EVM 会按照字节码指令进行操作。

    - 智能合约运行机制：

        1. 编写和编译：开发者使用 Solidity 或其他支持的语言编写智能合约代码，然后将其编译成 EVM 字节码。

        2. 部署：编译后的字节码通过一个以太坊交易被发送到网络，并存储在区块链上的特定地址处。

        3. 执行：当用户或另一个合约调用智能合约时，EVM 会加载并执行存储在该地址的字节码。

        4. 状态变更：智能合约的执行可能会改变以太坊的全局状态，例如更新账户余额或修改合约存储的数据。

        5. Gas消耗：智能合约的执行需要消耗 Gas，Gas 费用由发起交易的用户支付，用以激励网络中的节点执行和验证交易



